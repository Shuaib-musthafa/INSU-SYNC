<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CMS â€¢ Reports</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Predictive Analytics theme colors */
      --primary: #2596be;
      --secondary: #1e7a9b;
      --accent: #ffb74d;
      --dark: #1a1a2e;
      --light: #ffffff;
      --cream: #fef7f0;
      --gray: #686d76;
      --light-gray: #f5f5f5;
      
      --glass-light: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-shadow: rgba(31, 38, 135, 0.37);
      
      --brand: var(--primary);
      --bg: var(--light);
      --text: var(--dark);
      --card: var(--light);
      --card-foreground: var(--dark);
      --muted: var(--light-gray);
      --muted-foreground: var(--gray);
      --border: var(--light-gray);

      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 8px;

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 8px 32px 0 var(--glass-shadow);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    [data-theme="dark"] {
      --background: #0f172a;
      --foreground: #f8fafc;
      --card: #1e293b;
      --card-foreground: #f8fafc;
      --primary-foreground: #f8fafc;
      --muted: #1e293b;
      --muted-foreground: #94a3b8;
      --border: #334155;
      
      --glass-light: rgba(30, 41, 59, 0.5);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: rgba(2, 6, 23, 0.5);
      
      --brand-10: rgba(37, 150, 190, 0.15);
      --brand-15: rgba(37, 150, 190, 0.25);
      --brand-20: rgba(37, 150, 190, 0.3);
      --text-08: rgba(248, 250, 252, 0.08);
      --text-12: rgba(248, 250, 252, 0.12);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #0c4a6e 0%, #1e3a8a 100%);
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(37, 150, 190, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(30, 122, 155, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    [data-theme="dark"] .app::before {
      background: 
        radial-gradient(circle at 20% 80%, rgba(37, 150, 190, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(15, 23, 42, 0.3) 0%, transparent 50%);
    }

    /* Top Navigation */
    .topbar {
      height: 70px;
      background: var(--glass-light);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: var(--shadow-md);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      color: var(--dark);
    }

    .logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: grid;
      place-items: center;
      box-shadow: 0 4px 15px rgba(37, 150, 190, 0.3);
    }

    .logo svg {
      width: 16px;
      height: 16px;
      fill: white;
    }

    .nav-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      color: var(--text);
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      text-decoration: none;
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--glass-border);
      transform: translateY(-1px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--light);
      box-shadow: 0 6px 20px rgba(37, 150, 190, 0.3);
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
        .logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      box-shadow: 0 4px 15px rgba(37, 150, 190, 0.3);
    }

    .logo img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid var(--glass-border);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      display: grid;
      place-items: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .username {
      font-weight: 600;
      font-size: 14px;
    }

    .role {
      font-size: 12px;
      opacity: 0.7;
    }

    .logout-btn {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: 32px;
      position: relative;
      z-index: 1;
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Dashboard Container */
    .dashboard-container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: var(--glass-light);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      flex-wrap: wrap;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .dashboard-title i {
      color: var(--primary);
      font-size: 32px;
    }
    
    .header-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .last-updated {
      font-size: 14px;
      color: var(--gray);
      background: var(--cream);
      padding: 8px 12px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .refresh-btn {
      background: var(--primary);
      color: var(--light);
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
    }
    
    .chart-container {
      background: var(--glass-light);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      padding: 20px;
      height: 380px;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
    }
    
    .chart-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .chart-title {
      font-size: 18px;
      color: var(--dark);
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .chart-subtitle {
      font-size: 14px;
      color: var(--gray);
    }
    
    .col-span-4 {
      grid-column: span 4;
    }
    
    .col-span-6 {
      grid-column: span 6;
    }
    
    .col-span-12 {
      grid-column: span 12;
    }
    
    .performance-highlight {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--cream);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: var(--glass-light);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.3s;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray);
    }
    
    .improvement-badge {
      background: #e8f5e9;
      color: #2ecc71;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 8px;
      display: inline-block;
    }
    
    .data-source-note {
      text-align: center;
      margin-top: 20px;
      color: var(--gray);
      font-size: 14px;
      font-style: italic;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      gap: 15px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light-gray);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Floating elements */
    .floating-icon {
      position: absolute;
      color: rgba(37, 150, 190, 0.1);
      animation: float 6s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    .floating-icon.icon-1 {
      top: 20%;
      right: 10%;
      font-size: 3rem;
      animation-delay: 0s;
    }

    .floating-icon.icon-2 {
      bottom: 30%;
      left: 5%;
      font-size: 2rem;
      animation-delay: 2s;
    }

    .floating-icon.icon-3 {
      top: 60%;
      right: 15%;
      font-size: 2.5rem;
      animation-delay: 4s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-menu {
        display: none;
      }

      .topbar {
        padding: 0 16px;
      }

      .main {
        padding: 16px;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-info {
        width: 100%;
        justify-content: space-between;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .col-span-4, .col-span-6 {
        grid-column: span 12;
      }
      
      .floating-icon {
        display: none;
      }
    }

    @media (max-width: 1400px) {
      .col-span-4 {
        grid-column: span 6;
      }
    }

    #appointmentsChart, #serviceChart, #careQualityChart {
        max-height: 200px;
    }

    /* Message Modal */
    .message-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .message-modal.show {
      display: flex;
    }

    .message-content {
      background: var(--glass-light);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      padding: 32px;
      border-radius: var(--radius-lg);
      max-width: 400px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .message-content p {
      margin-bottom: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
<div class="app">
  <i class="fas fa-chart-line floating-icon icon-1"></i>
  <i class="fas fa-star floating-icon icon-2"></i>
  <i class="fas fa-analytics floating-icon icon-3"></i>

  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Brand Logo" />
      </div>
      <span>INSU-SYNC</span>
    </div>

    <nav class="nav-menu">
    <a href="/dashboard" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="/weak" class="nav-item">
      <i class="fas fa-exclamation-triangle"></i>
      <span>Weak Areas</span>
    </a>
    <a href="/simulator" class="nav-item">
      <i class="fas fa-calculator"></i>
      <span>Simulator</span>
    </a>
    <a href="/reports" class="nav-item">
      <i class="fas fa-chart-bar"></i>
      <span>Reports</span>
    </a>
    <a href="/settings" class="nav-item">
      <i class="fas fa-cog"></i>
      <span>Settings</span>
    </a>
  </nav>

    <div class="top-right">
      <div class="user-info">
        <div class="avatar">
          <span id="username-avatar">{{username[0].upper() if username else 'U'}}</span>
        </div>
        <div class="user-details">
          <span class="username" id="username-display">{{username or 'User'}}</span>
        </div>
      </div>
      <a href="/logout" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i>
        Logout
      </a>
    </div>
  </header>
  <main class="main">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
              Performance Report
            </h1>
            <div class="header-info">
                <div class="last-updated" id="lastUpdated">
                    <i class="fas fa-clock"></i> Last updated: Loading...
                </div>
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Overall Rating</div>
                <div class="improvement-badge"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Appointment Satisfaction</div>
                <div class="improvement-badge"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Service Satisfaction</div>
                <div class="improvement-badge"></div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="chart-container col-span-4">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Overall Performance Rating</h3>
                        <div class="chart-subtitle">Current period assessment</div>
                    </div>
                </div>
                <canvas id="gaugeChart"></canvas>
                <div class="performance-highlight">
                    <i class="fas fa-star" style="color: var(--primary);"></i>
                    <span id="overallRatingText">-</span>
                </div>
            </div>
            
            <div class="chart-container col-span-4">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Performance Measures</h3>
                        <div class="chart-subtitle">Best vs. Needs Improvement</div>
                    </div>
                </div>
                <canvas id="topBottomChart"></canvas>
            </div>
            
            <div class="chart-container col-span-4">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Domain Performance</h3>
                        <div class="chart-subtitle">Score comparison</div>
                    </div>
                </div>
                <canvas id="domainChart"></canvas>
            </div>
            
            <div class="chart-container col-span-4">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Patient Experience</h3>
                        <div class="chart-subtitle">Appointments Satisfaction</div>
                    </div>
                </div>
                <canvas id="appointmentsChart"></canvas>
                <div class="performance-highlight">
                    <i class="fas fa-calendar-check" style="color: var(--accent);"></i>
                    <span id="appointmentsScore">-</span>
                </div>
            </div>
            
            <div class="chart-container col-span-4">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Patient Experience</h3>
                        <div class="chart-subtitle">Customer Service Satisfaction</div>
                    </div>
                </div>
                <canvas id="serviceChart"></canvas>
                <div class="performance-highlight">
                    <i class="fas fa-headset" style="color: var(--accent);"></i>
                    <span id="serviceScore">-</span>
                </div>
            </div>
            
            <div class="chart-container col-span-4">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Patient Experience</h3>
                        <div class="chart-subtitle">Care Quality Satisfaction</div>
                    </div>
                </div>
                <canvas id="careQualityChart"></canvas>
                <div class="performance-highlight">
                    <i class="fas fa-stethoscope" style="color: var(--accent);"></i>
                    <span id="careQualityScore">-</span>
                </div>
            </div>
            
            <div class="chart-container col-span-12">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Performance Trend Over Time</h3>
                        <div class="chart-subtitle">Historical rating progression</div>
                    </div>
                </div>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        
        <div class="data-source-note" id="dataSourceNote">
            Connecting to backend API...
        </div>
    </div>
  </main>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading healthcare data...</p>
</div>

<script>
  // Chart instances
let gaugeChart, topBottomChart, domainChart, appointmentsChart, serviceChart, careQualityChart, trendChart;

// DOM elements
const refreshBtn = document.getElementById('refreshBtn');
const lastUpdated = document.getElementById('lastUpdated');
const overallRatingText = document.getElementById('overallRatingText');
const appointmentsScore = document.getElementById('appointmentsScore');
const serviceScore = document.getElementById('serviceScore');
const careQualityScore = document.getElementById('careQualityScore');
const dataSourceNote = document.getElementById('dataSourceNote');
const loadingOverlay = document.getElementById('loadingOverlay');
const statsGrid = document.getElementById('statsGrid');

// Message Modal Functions
function showMessage(message) {
  const modal = document.getElementById('messageModal');
  const text = document.getElementById('messageText');
  if (text) {
      text.textContent = message;
  }
  if (modal) {
      modal.classList.add('show');
  }
}

function closeMessage() {
  const modal = document.getElementById('messageModal');
  if (modal) {
      modal.classList.remove('show');
  }
}

// Update last updated timestamp
function updateLastUpdated() {
  const now = new Date();
  const formattedDate = now.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  if (lastUpdated) {
      lastUpdated.innerHTML = `<i class="fas fa-clock"></i> Last updated: ${formattedDate}`;
  }
}

// Fetch data from backend
async function fetchData() {
  if (refreshBtn) {
      refreshBtn.disabled = true;
  }
  if (loadingOverlay) {
      loadingOverlay.style.display = 'flex';
  }
  
  try {
    // Mocking the fetch call since there's no live backend
    const data = await new Promise(resolve => setTimeout(() => resolve(generateMockData()), 1000));
    
    // Process and visualize the data
    processData(data);
    updateLastUpdated();
    
    if (dataSourceNote) {
      dataSourceNote.textContent = "Demonstration data loaded successfully.";
    }
    
  } catch (error) {
    console.error('Error fetching data:', error);
    if (dataSourceNote) {
      dataSourceNote.textContent = "Error loading data. Using mock data.";
    }
    const mockData = generateMockData();
    processData(mockData);
  } finally {
    if (refreshBtn) {
      refreshBtn.disabled = false;
    }
    if (loadingOverlay) {
      loadingOverlay.style.display = 'none';
    }
  }
}

// Process data and update charts
function processData(data) {
  // Update stats grid
  updateStatsGrid(data);
  
  // Update Overall Performance (Gauge)
  updateGaugeChart(data.overallRating);
  
  // Update Top vs Bottom Measures
  updateTopBottomChart(data.topMeasures, data.bottomMeasures);
  
  // Update Domain-Wise Grouping
  updateDomainChart(data.domainData);
  
  // Update Patient Experience Breakdown - Now 3 charts
  updatePatientExperienceCharts(data.patientExperience);
  
  // Update Trend Comparison
  updateTrendChart(data.trendData);
}

// Update stats grid with data
function updateStatsGrid(data) {
  const statCards = statsGrid.querySelectorAll('.stat-card');
  if (statCards.length > 0) {
      // Overall Rating
      const overallRatingEl = statCards[0].querySelector('.stat-value');
      if (overallRatingEl) {
          overallRatingEl.textContent = `${data.overallRating.toFixed(1)}/5.0`;
      }
      
      // Appointment Satisfaction
      const appointmentsEl = statCards[1].querySelector('.stat-value');
      if (appointmentsEl) {
          const appointmentsPercent = (data.patientExperience.appointments * 100).toFixed(1);
          appointmentsEl.textContent = `${appointmentsPercent}%`;
      }
      
      // Service Satisfaction
      const serviceEl = statCards[2].querySelector('.stat-value');
      if (serviceEl) {
          const servicePercent = (data.patientExperience.customerService * 100).toFixed(1);
          serviceEl.textContent = `${servicePercent}%`;
      }
  }
}

// Update Gauge Chart
function updateGaugeChart(rating) {
  const canvas = document.getElementById('gaugeChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (gaugeChart) {
    gaugeChart.destroy();
  }
  
  // Update the rating text
  if (overallRatingText) {
      overallRatingText.textContent = `${rating.toFixed(1)}/5.0`;
  }
  
  gaugeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [rating, 5 - rating],
        backgroundColor: [
          rating >= 4 ? '#2ecc71' : rating >= 3 ? '#f39c12' : '#e74c3c',
          '#ecf0f1'
        ],
        borderWidth: 0,
        circumference: 180,
        rotation: 270
      }]
    },
    options: {
      aspectRatio: 1.7,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false },
      },
      cutout: '70%'
    }
  });
}

// Update Top vs Bottom Chart
function updateTopBottomChart(topMeasures, bottomMeasures) {
  const canvas = document.getElementById('topBottomChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (topBottomChart) {
    topBottomChart.destroy();
  }
  
  const labels = [...topMeasures.map(m => m.measure), ...bottomMeasures.map(m => m.measure)];
  const data = [...topMeasures.map(m => m.score * 100), ...bottomMeasures.map(m => m.score * 100)];
  
  topBottomChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Score (%)',
        data: data,
        backgroundColor: [
          '#2ecc71', '#2ecc71', '#2ecc71',
          '#e74c3c', '#e74c3c'
        ],
        borderWidth: 0,
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Score: ${context.raw.toFixed(1)}%`;
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Performance Score (%)'
          },
          grid: {
            color: '#f0f0f0'
          }
        },
        y: {
          grid: {
            display: false
          }
        }
      }
      }
  });
}

// Update Domain Chart
function updateDomainChart(domainData) {
  const canvas = document.getElementById('domainChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (domainChart) {
    domainChart.destroy();
  }
  
  const labels = domainData.map(item => item.period);
  const domains = ['Preventive Care', 'Chronic Condition Management', 'Patient Experience', 'Plan Administration'];
  const colors = ['#3498db', '#2ecc71', '#ffb74d', '#9b59b6']; // Updated accent color
  
  const datasets = domains.map((domain, index) => {
    return {
      label: domain,
      data: domainData.map(item => item[domain] * 100),
      backgroundColor: colors[index],
      borderRadius: 4,
      borderSkipped: false,
    };
  });
  
  domainChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.raw.toFixed(1)}%`;
            }
          }
        },
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 15
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Time Period'
          },
          grid: {
            color: '#f0f0f0'
          }
        },
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Performance Score (%)'
          },
          grid: {
            color: '#f0f0f0'
          }
        }
      }
    }
  });
}

// Update Patient Experience Charts - Now 3 charts
function updatePatientExperienceCharts(patientData) {
  // Update Appointments Chart
  updateDonutChart('appointmentsChart', patientData.appointments, 'Appointments', '#3498db');
  
  // Update Customer Service Chart
  updateDonutChart('serviceChart', patientData.customerService, 'Customer Service', '#2ecc71');
  
  // Update Care Quality Chart
  updateDonutChart('careQualityChart', patientData.careQuality, 'Care Quality', '#9b59b6');
  
  // Update scores
  if (appointmentsScore) {
      appointmentsScore.textContent = `${(patientData.appointments * 100).toFixed(1)}%`;
  }
  if (serviceScore) {
      serviceScore.textContent = `${(patientData.customerService * 100).toFixed(1)}%`;
  }
  if (careQualityScore) {
      careQualityScore.textContent = `${(patientData.careQuality * 100).toFixed(1)}%`;
  }
}

function updateDonutChart(canvasId, value, title, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let chart;
  
  if (canvasId === 'appointmentsChart') {
    chart = appointmentsChart;
  } else if (canvasId === 'serviceChart') {
    chart = serviceChart;
  } else {
    chart = careQualityChart;
  }
  
  if (chart) {
    chart.destroy();
  }
  
  const newChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Satisfaction', 'Dissatisfaction'],
      datasets: [{
        data: [value * 100, 100 - (value * 100)],
        backgroundColor: [color, '#95a5a6'],
        borderWidth: 0,
        borderRadius: 4,
        borderAlign: 'inner'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw.toFixed(1)}%`;
            }
          }
        }
      },
      cutout: '70%'
    }
  });
  
  if (canvasId === 'appointmentsChart') {
    appointmentsChart = newChart;
  } else if (canvasId === 'serviceChart') {
    serviceChart = newChart;
  } else {
    careQualityChart = newChart;
  }
}

// Update Trend Chart
function updateTrendChart(trendData) {
  const canvas = document.getElementById('trendChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (trendChart) {
    trendChart.destroy();
  }
  
  // Generate labels as Record 1, Record 2, ...
  const labels = trendData.map((_, index) => `Record ${index + 1}`);
  const data = trendData.map(item => item.rating);
  
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Overall Rating',
        data: data,
        borderColor: '#3498db',
        backgroundColor: 'rgba(52, 152, 219, 0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#3498db',
        pointBorderColor: '#fff',
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Records'
          },
          grid: {
            color: '#f0f0f0'
          }
        },
        y: {
          min: 0,
          max: 5,
          ticks: {
            stepSize: 0.5
          },
          title: {
            display: true,
            text: 'Rating'
          },
          grid: {
            color: '#f0f0f0'
          }
        }
      }
    }
  });
}

// Generate mock data for demonstration if backend is unavailable
function generateMockData() {
  return {
    overallRating: 4.0,
    topMeasures: [
      { measure: 'Breast Cancer Screening', score: 0.92 },
      { measure: 'Colorectal Cancer Screening', score: 0.85 },
      { measure: 'Annual Flu Vaccine', score: 0.78 }
    ],
    bottomMeasures: [
      { measure: 'Pain Assessment', score: 0.35 },
      { measure: 'Medication Review', score: 0.42 }
    ],
    domainData: [
      {
        period: 'Current',
        'Preventive Care': 0.82,
        'Chronic Condition Management': 0.75,
        'Patient Experience':  0.68,
        'Plan Administration': 0.79
      },
      {
        period: 'Previous',
        'Preventive Care': 0.78,
        'Chronic Condition Management': 0.72,
        'Patient Experience': 0.65,
        'Plan Administration': 0.74
      }
    ],
    patientExperience: {
      appointments: 0.356,
      customerService: 0.899,
      careQuality: 0.82
    },
    trendData: [
      { period: 'Jan', rating: 3.8 },
      { period: 'Feb', rating: 3.9 },
      { period: 'Mar', rating: 4.1 },
      { period: 'Apr', rating: 4.0 },
      { period: 'May', rating: 4.2 },
      { period: 'Jun', rating: 4.0 }
    ]
  };
}

// Initialize the dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Theme-loading logic
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
  }

  // Set active navigation
  const currentPath = window.location.pathname;
  document.querySelectorAll('.nav-item').forEach(item => {
    if (item.getAttribute('href') === currentPath) {
      item.classList.add('active');
    }
  });
  
  // Set up refresh button
  if (refreshBtn) {
    refreshBtn.addEventListener('click', fetchData);
  }
  
  // Load data initially
  fetchData();
});
</script>

<div class="message-modal" id="messageModal">
  <div class="message-content">
    <p id="messageText"></p>
    <button class="message-close" onclick="closeMessage()">OK</button>
  </div>
</div>
</body>
</html>